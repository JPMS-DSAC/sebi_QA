from operator import itemgetter
from keras.models import load_model
from model import SiameseBiLSTM
from inputHandler import word_embed_meta_data, create_test_data
from config import siamese_config
import pandas as pd

df = pd.read_csv('sample_data.csv')

sentences1 = list(df['sentences1'])
sentences2 = list(df['sentences2'])
is_similar = list(df['is_similar'])
del df

best_model_path = '/home/deepti-saravanan/Desktop/lstm-siamese-text-similarity-master/checkpoints/1615225073/lstm_50_50_0.17_0.25.h5'
model = load_model(best_model_path)
'''
test_sentence_pairs = [('(2), (2A) and (3) of section 11 and section 11B  of the Act, by an order, for reasons to be recorded in writing, in the interests of investors and securities market, issue or take any of the  following   actions   or  directions,  either  pending  investigation   or  enquiry   or  on completion of such investigation or enquiry, namely:— (a)  suspend the trading of the security found to be or prima facie found to be involved in fraudulent and unfair trade practice in a recognized stock exchange; (b)  restrain   persons   from   accessing   the   securities   market   and   prohibit   any   person associated with securities market to buy, sell or deal in securities; (c)  suspend any office-bearer of any stock exchange or self-regulatory organization from holding such position; (d)  impound and retain the proceeds or securities in respect of any transaction which is in violation or prima facie in violation of these regulations; (e)  direct  and  intermediary  or  any  person  associated  with  the  securities  market  in  any manner not  to  dispose of or alienate  an  asset forming part of  a fraudulent  and unfair transaction; (f)  require  the  person  concerned  to  call  upon  any  of  its  officers,  other  employees  or 12 representatives to refrain from dealing in securities in any particular manner; (g)  prohibit  the  person  concerned  from  disposing  of  any  of  the  securities  acquired  in contravention of these regulations; (h)  direct   the   person   concerned   to   dispose   of   any   such   securities   acquired   in contravention  of  these  regulations,  in  such  manner  as  the  Board  may  deem  fit,  for restoring the status quo ante;'),('(2)  Dealing in securities shall be deemed to be a  6[manipulative] fraudulent or an unfair trade practice if it involves 7[any of the following]:— (a)  8[knowingly] indulging in an act which creates false or misleading appearance of trading in the securities market; (b)  dealing  in  a  security  not  intended  to  effect  transfer  of  beneficial  ownership  but intended  to  operate  only  as  a  device  to  inflate,  depress  or  cause  fluctuations  in the price of such security for wrongful gain or avoidance of loss; 9[(c)  inducing  any  person  to  subscribe  to  an  issue  of  the    securities  for  fraudulently securing  the  minimum  subscription  to  such  issue  of  securities,  by  advancing  or agreeing to advance any money to any other person or through any other means;] 10[(d)    inducing  any  person  for  dealing  in  any  securities  for  artificially  inflating, depressing,  maintaining  or  causing  fluctuation  in  the  price  of  securities  through any means including by paying, offering or agreeing to pay or offer any money or money worth, directly or indirectly, to any person;] (e)  any  act  or  omission  amounting  to  manipulation  of  the  price  of  a  security 11[including,  influencing  or  manipulating  the  reference  price  or  bench  mark  price  of any securities]; (f)  12[knowingly] publishing  or  causing  to  publish  or  reporting  or  causing  to  report by  a  person  dealing  in  securities  any  information  13[relating  to  securities, including  financial  results,  financial  statements,  mergers  and  acquisitions, regulatory  approvals,]  which  is  not  true  or  which  he  does  not  believe  to  be  true prior to or in the course of dealing in securities; (g)  entering  into  a  transaction  in  securities  without  intention  of  performing  it  or without intention of change of ownership of such security; 14[(h)  selling,  dealing  or  pledging  of  stolen,  counterfeit  or  fraudulently  issued securities whether in physical or dematerialized form: Provided that if:- (i) the  person  selling,  dealing  in  or  pledging  stolen,  counterfeit  or  fraudulently issued securities was a holder in due course; or (ii)  the stolen, counterfeit or fraudulently issued securities were previously traded on the market through a bonafide transaction, (iii)  such selling, dealing or pledging of stolen, counterfeit or fraudulently issued securities  shall  not  be  considered  as  a  manipulative,  fraudulent,  or  unfair trade practice;] 10  Substituted  vide  Securities  and  Exchange  Board  of  India  (Prohibition  of  Fraudulent  and  Unfair  Trade 15[(i)  ***] 16[(j)  ***] (k)  17["disseminating  information  or  advice  through  any  media,  whether  physical  or digital,  which  the  disseminator  knows  to  be  false  or  misleading  and  which  is designed or likely to influence the decision of investors dealing in securities;] 18[(l) ***]; (m)  19[a  market  participant  entering  into  transactions  on  behalf  of  client  without  the knowledge of or instructions from client or misutilizing or diverting the funds or securities of the client held in fiduciary capacity"]; (n)  circular  transactions  in  respect  of  a  security  entered  into  between  20[persons including  intermediaries  to  artificially]  provide  a  false  appearance  of  trading  in such  security  or  to  inflate,  depress  or  cause  fluctuations  in  the  price  of  such security; (o) 21[fraudulent inducement of any person by a market participant to deal in securities with the objective of enhancing his brokerage or commission or income;] (p)  an  intermediary  predating  or  otherwise  falsifying  records  22[including  contract instructions,  balance  of  securities  statement,  client  account notes,  client statements]; (q)  23[any  order  in  securities  placed  by  a  person,  while  directly  or  indirectly  in possession  of information  that is  not  publically  available, regarding a substantial impending transaction in that securities, its underlying securities or its derivative;] (r)   24[knowingly] planting   false   or   misleading   news   which   may   induce   sale or   purchase   of securities. 25[(s) 26{mis-selling of securities or services relating to securities market; securities or services relating to  securities market  by  any person, directly or indirectly, by─ (i)  knowingly making a false or misleading statement, or "encouraging  the  clients  by  an  intermediary  to  deal  in  securities  solely  with  the  object  of  enhancing  his brokerage or commission;" (ii) knowingly concealing or omitting material facts, or (iii)knowingly concealing the associated risk, or (iv) not  taking  reasonable  care  to  ensure  suitability  of  the  securities  or service to the buyer}]; 27[(t)  illegal  mobilization  of  funds  by  sponsoring  or  causing  to  be  sponsored  or carrying on or causing to be carried on any collective investment scheme by any person.] is  clarified  that  the  acts  or  omissions  listed  in  this  sub-regulation  are  not  exhaustive  and that  an  act  or  omission  is  prohibited  if  it  falls  within  the  purview  of  regulation  3, notwithstanding  that  it  is  not  included  in  this  sub-regulation  or  is  described  as  being committed only by a certain category of persons in this sub-regulation.] Section 12 of the Act and its employees and agents. CHAPTER III INVESTIGATION Power of the Board to order investigation')]

test_sentence_pairs = [('(6)  to examine on oath any manager, managing director, officer or other employee of any intermediary  or  any  person  associated  with  securities  market  in  any  manner  in relation to the affairs of his business and may administer an oath accordingly and for that purpose may require any of those persons to appear before him personally. Power of the Investigating Authority to be exercised with prior approval','(2)  to undertake inspection of  any book, or  register, or other document or record of  any listed  public  company  or  a  public  company  (not  being  intermediaries  referred  to  in section 12 of the Act) which intends to get its securities listed on any recognized stock exchange  where  the  Investigating  Authority  has  reasonable  grounds  to  believe  that such company has been conducting in violation of these regulations'),('(6)  to examine on oath any manager, managing director, officer or other employee of any intermediary  or  any  person  associated  with  securities  market  in  any  manner  in relation to the affairs of his business and may administer an oath accordingly and for that purpose may require any of those persons to appear before him personally. Power of the Investigating Authority to be exercised with prior approval','(2)  to undertake inspection of  any book, or  register, or other document or record of  any listed  public  company  or  a  public  company  (not  being  intermediaries  referred  to  in section 12 of the Act) which intends to get its securities listed on any recognized stock exchange  where  the  Investigating  Authority  has  reasonable  grounds  to  believe  that such company has been conducting in violation of these regulations')]
'''

test_sentence_pairs = [('What can make Physics easy to learn?','How can you make physics easy to learn?'),('How many times a day do a clocks hands overlap?','What does it mean that every time I look at the clock the numbers are the same?')]

tokenizer, embedding_matrix = word_embed_meta_data(sentences1 + sentences2, siamese_config['EMBEDDING_DIM'])

test_data_x1, test_data_x2, leaks_test = create_test_data(tokenizer,test_sentence_pairs,  siamese_config['MAX_SEQUENCE_LENGTH'])

preds = list(model.predict([test_data_x1, test_data_x2, leaks_test], verbose=1).ravel())
print(preds)
results = [(x, y, z) for (x, y), z in zip(test_sentence_pairs, preds)]
results.sort(key=itemgetter(2), reverse=True)
print(results)
